version: '3.8'

services:
  # dGraph database
  dgraph-zero:
    image: dgraph/dgraph:latest
    volumes:
      - dgraph_zero:/dgraph
    ports:
      - "5080:5080"
      - "8000:8000"
    restart: unless-stopped
    command: dgraph zero --my=dgraph-zero:5080

  dgraph-alpha:
    image: dgraph/dgraph:latest
    volumes:
      - dgraph_alpha:/dgraph
    ports:
      - "8080:8080"
      - "9080:9080"
    restart: unless-stopped
    command: dgraph alpha --my=dgraph-alpha:7080 --zero=dgraph-zero:5080 --lru_mb=2048
    depends_on:
      - dgraph-zero

  # SUI Service
  sui-service:
    build:
      context: ../services/sui-service
      dockerfile: Dockerfile
    ports:
      - "3001:3001"
    environment:
      - NODE_ENV=development
      - PORT=3001
      - SUI_NETWORK=testnet
      - LOG_LEVEL=info
      - JWT_SECRET=development-jwt-secret-key-change-in-production
      - POLL_INTERVAL=30000
    restart: unless-stopped
    volumes:
      - ../services/sui-service/logs:/app/logs

  # Walrus Service
  walrus-service:
    build:
      context: ../services/walrus-service
      dockerfile: Dockerfile
    ports:
      - "3002:3002"
    environment:
      - NODE_ENV=development
      - PORT=3002
      - LOG_LEVEL=info
      - WALRUS_BASE_URL=https://walrus-testnet.mrgnlabs.xyz
      - MAX_FILE_SIZE=52428800
    restart: unless-stopped
    volumes:
      - ../services/walrus-service/logs:/app/logs

  # dGraph Service
  dgraph-service:
    build:
      context: ../services/dgraph-service
      dockerfile: Dockerfile
    ports:
      - "3003:3003"
    environment:
      - NODE_ENV=development
      - PORT=3003
      - LOG_LEVEL=info
      - DGRAPH_HOST=dgraph-alpha:9080
      - DGRAPH_USER=groot
      - DGRAPH_PASSWORD=password
      - GRAPHQL_INTROSPECTION=true
      - GRAPHQL_PLAYGROUND=true
    restart: unless-stopped
    depends_on:
      - dgraph-alpha
    volumes:
      - ../services/dgraph-service/logs:/app/logs

  # Presence Service
  presence-service:
    build:
      context: ../services/presence-service
      dockerfile: Dockerfile
    ports:
      - "3004:3004"
      - "3005:3005"
    environment:
      - NODE_ENV=development
      - PORT=3004
      - LOG_LEVEL=info
      - HOCUSPOCUS_PORT=3005
      - TURN_HOST=localhost
      - TURN_PORT=3478
      - STUN_HOST=localhost
      - STUN_PORT=3478
      - WEBRTC_TIMEOUT=30000
      - MAX_PARTICIPANTS_PER_SESSION=50
    restart: unless-stopped
    volumes:
      - ../services/presence-service/logs:/app/logs

  # Sandbox Service (placeholder - would need custom reverse proxy)
  # sandbox-service:
  #   build:
  #     context: ../frontend/sandbox
  #     dockerfile: Dockerfile
  #   ports:
  #     - "3006:3006"
  #   environment:
  #     - NODE_ENV=development
  #     - PORT=3006
  #   depends_on:
  #     - walrus-service
  #     - sui-service

  # Vue Frontend
  vue-app:
    build:
      context: ../frontend/vue-app
      dockerfile: Dockerfile
    ports:
      - "3000:80"
    environment:
      - NODE_ENV=development
      - VITE_GRAPHQL_URL=http://localhost:3003/graphql
    restart: unless-stopped

volumes:
  dgraph_zero:
  dgraph_alpha: